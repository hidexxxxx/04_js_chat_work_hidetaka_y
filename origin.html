<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
</head>

<body>

    <main>
        <form>
            <fieldset>
                <legend>ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ç”»é¢</legend>
                <div>
                    name: <input type="text" id="name">
                </div>
                <div>
                    text: <input type="text" id="text">
                </div>
                <div>
                    <button type="button" id="send">send</button>
                </div>
            </fieldset>
        </form>

        <!-- ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›å ´æ‰€ -->
        <ul id="output"></ul>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/ui/4.8.0/firebase-ui-auth.js"></script>
        <link type="text/css" rel="stylesheet"
            href="https://www.gstatic.com/firebasejs/ui/4.8.0/firebase-ui-auth.css" />
        <script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-auth.js"></script>
        <script>

            let ui = new firebaseui.auth.AuthUI(firebase.auth());
            let uiConfig = {
                callbacks: {
                    signInSuccessWithAuthResult: function () {
                        console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ")
                        return true;
                    },
                },
                signInOptions: [
                    firebase.auth.EmailAuthProvider.PROVIDER_ID,
                ],
            };

            let ui = new firebaseui.auth.AuthUI(firebase.auth());
            ui.start('#firebaseui-auth-container', uiConfig);
        </script>
        <script>
            //ã¾ãšã¯ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã›ã‚‹ã‹ã‚’ç¢ºèªã€‚ãã—ã¦ã†ã¾ãã„ã£ã¦ã„ã‚Œã°æ¡ä»¶ã®å¤‰æ›´ã‚’åŠ ãˆã‚‹ã€‚
            // æ—¥æ™‚ã‚’ã„ã„æ„Ÿã˜ã®å½¢å¼ã«ã™ã‚‹é–¢æ•°
            function convertTimestampToDatetime(timestamp) {
                const _d = timestamp ? new Date(timestamp * 1000) : new Date();
                const Y = _d.getFullYear();
                const m = (_d.getMonth() + 1).toString().padStart(2, '0');
                const d = _d.getDate().toString().padStart(2, '0');
                const H = _d.getHours().toString().padStart(2, '0');
                const i = _d.getMinutes().toString().padStart(2, '0');
                const s = _d.getSeconds().toString().padStart(2, '0');
                return `${Y}/${m}/${d} ${H}:${i}:${s}`;
            }
        </script>

        <script type="module">

            import {
                initializeApp
            } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";

            // ğŸ”½ è¿½åŠ 
            import {
                getFirestore,
                collection,
                addDoc,
                serverTimestamp,
                //onsnapshotã‚’è¿½åŠ ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‡¦ç†ã‚’å®Ÿè¡Œã•ã›ã‚‹
                onSnapshot,
                //orderbyã§ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆã¨orderbyã§
                query,
                orderBy,
            } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyDqf3qjYRNEFPSujgt4XjDA3rk_M4OCtZk",
                authDomain: "jswork-7558c.firebaseapp.com",
                projectId: "jswork-7558c",
                storageBucket: "jswork-7558c.appspot.com",
                messagingSenderId: "215719114362",
                appId: "1:215719114362:web:fe555875017463a7856dc3"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);

            // ğŸ”½ è¿½åŠ 
            const db = getFirestore(app);

            $("#send").on("click", function () {
                // é€ä¿¡æ™‚ã«å¿…è¦ãªå‡¦ç†
                const postData = {
                    name: $("#name").val(),
                    text: $("#text").val(),
                    time: serverTimestamp(),
                };
                //ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«chatã¨ã„ã†åå‰ã§ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ã„ã‚‹
                addDoc(collection(db, "chat"), postData);
                $("#text").val("");
            });

            // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯æ™‚é–“ã®æ–°ã—ã„é †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
            const q = query(collection(db, "chat"), orderBy("time", "desc"));

            // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†
            onSnapshot(q, (querySnapshot) => {
                console.log(querySnapshot.docs);
                //querySnapshot.docsã‚’å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡ºã—ãŸã€Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®é…åˆ—ã€ã«å¤‰æ›
                const documents = [];
                querySnapshot.docs.forEach(function (doc) {
                    const document = {
                        id: doc.id,
                        data: doc.data(),
                    };
                    documents.push(document);
                });

                console.log(documents);
                //å¿…è¦ãªæƒ…å ±ã®ã¿ã‚’æŠ½å‡ºã—ãŸé…åˆ—ãŒä½œæˆã§ããŸãŸã‚ã“ã®é…åˆ—ã‹ã‚‰ç”»é¢è¡¨ç¤ºç”¨ã®ã‚¿ã‚°ã‚’ä½œæˆ
                //æ™‚åˆ»å½¢å¼ã‚’å¤‰æ›
                const htmlElements = [];
                documents.forEach(function (document) {
                    htmlElements.push(`
                    <li id="${document.id}">
                    <p>${document.data.name} at ${convertTimestampToDatetime(document.data.time.seconds)}</p>
                    <p>${document.data.text}</p>
                    </li>
                    `);
                });

                $("#output").html(htmlElements);
            });

        </script>
    </main>
</body>

<footer>
    <nav class="wrapper-footer">
        <ul class="menu-footer">
            <li><a href="#">åˆã‚ã¦ã®æ–¹ã¸</a></li>
            <li><a href="#">ã‚ˆãã‚ã‚‹è³ªå•</a></li>
            <li><a href="#">åˆ©ç”¨è¦ç´„</a></li>
            <li><a href="#">ç‰¹å®šå•†å“å–å¼•æ³•</a></li>
            <li><a href="#">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></li>
            <li><a href="#">ãŠå•ã„åˆã‚ã›</a></li>
            <li><a href="#">ä¼šç¤¾æ¦‚è¦</a></li>
        </ul>
    </nav>
    <h5 class="copy-rights">Â©ï¸2023 Cloud Garage Co,.Ltd. All Rights Reserved</h5>
</footer>

</html>
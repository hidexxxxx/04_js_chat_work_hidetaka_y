<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="chat.css">
    <title>ã‚·ãƒ‹ã‚¢Ã—ä¾›çµ¦è€…ãƒãƒƒãƒãƒ³ã‚°</title>
</head>

<body>

    <main>
        <header id="header">
            <div class="logo-box">
                <a href="index.html"><img class="brand-logo" src="img/otasuke-logo.png" alt="logo"></a>
            </div>
            <nav class="wrapper">
                <ul class="menu">
                    <li class="menu-area"><a onclick="location.href='search-pulldown.html';">ã‚¨ãƒªã‚¢é¸æŠ</a></li>
                    <li class="menu-chat"><a onclick="location.href='chat.html';">ãƒãƒ£ãƒƒãƒˆç”»é¢</a></li>
                    <li class="menu-mypage"><a onclick="location.href='mypage.html';">ãƒã‚¤ãƒšãƒ¼ã‚¸</a></li>
                    <li class="menu-community"><a onclick="location.href='community.html';">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼</a></li>
                </ul>
                <ul class="login">
                    <li class="menu-login"><a onclick="location.href='index.html';">ãƒ­ã‚°ã‚¤ãƒ³</a></li>
                    <li class="login-contact"><a onclick="location.href='contact.html';">ãŠå•ã„åˆã‚ã›</a></li>
                </ul>
            </nav>
        </header>
        <p class="caution">ã‚µãƒãƒ¼ãƒˆã‚’å—ã‘ãŸã„æ—¥æ™‚ / é‡‘é¡ / ãã®ä»–ãªã©ã‚’ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚</p>
        <div class="container">
            <div class="chat-area">
                <ol>
                    <!-- ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›å ´æ‰€ -->
                    <li id="output"></li>
                </ol>
            </div>

            <!-- ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ç”»é¢ -->
            <form>
                <fieldset>
                    <legend>å…¥åŠ›ç”»é¢</legend>
                    <div class="messege-area">
                        <div class="messege-area-name">
                            <label for="name">åå‰:</label>
                            <input type="text" id="name" class="name">
                        </div>
                        <div class="messege-area-text">
                            <label for="text">å†…å®¹:</label>
                            <textarea rows="4" id="text" class="text"></textarea>
                        </div>
                        <div class="messege-area-button">
                            <button type="button" id="send" class="button">é€ä¿¡</button>
                        </div>
                    </div>
                </fieldset>
            </form>
            <div class="review">
                <p class="review-form" onclick="location.href='review-form.html';">â­ï¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸ã¸</p>
            </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/ui/4.8.0/firebase-ui-auth.js"></script>
        <link type="text/css" rel="stylesheet"
            href="https://www.gstatic.com/firebasejs/ui/4.8.0/firebase-ui-auth.css" />
        <script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-auth.js"></script>
        <script>

            let ui = new firebaseui.auth.AuthUI(firebase.auth());
            let uiConfig = {
                callbacks: {
                    signInSuccessWithAuthResult: function () {
                        console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ")
                        return true;
                    },
                },
                signInOptions: [
                    firebase.auth.EmailAuthProvider.PROVIDER_ID,
                ],
            };

            let ui = new firebaseui.auth.AuthUI(firebase.auth());
            ui.start('#firebaseui-auth-container', uiConfig);
        </script>
        <script>
            //ã¾ãšã¯ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã›ã‚‹ã‹ã‚’ç¢ºèªã€‚ãã—ã¦ã†ã¾ãã„ã£ã¦ã„ã‚Œã°æ¡ä»¶ã®å¤‰æ›´ã‚’åŠ ãˆã‚‹ã€‚
            // æ—¥æ™‚ã‚’ã„ã„æ„Ÿã˜ã®å½¢å¼ã«ã™ã‚‹é–¢æ•°
            function convertTimestampToDatetime(timestamp) {
                const _d = timestamp ? new Date(timestamp * 1000) : new Date();
                const Y = _d.getFullYear();
                const m = (_d.getMonth() + 1).toString().padStart(2, '0');
                const d = _d.getDate().toString().padStart(2, '0');
                const H = _d.getHours().toString().padStart(2, '0');
                const i = _d.getMinutes().toString().padStart(2, '0');
                const s = _d.getSeconds().toString().padStart(2, '0');
                return `${Y}/${m}/${d} ${H}:${i}:${s}`;
            }
        </script>

        <script type="module">

            import {
                initializeApp
            } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";

            // ğŸ”½ è¿½åŠ 
            import {
                getFirestore,
                collection,
                addDoc,
                serverTimestamp,
                //onsnapshotã‚’è¿½åŠ ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‡¦ç†ã‚’å®Ÿè¡Œã•ã›ã‚‹
                onSnapshot,
                //orderbyã§ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆã¨orderbyã§
                query,
                orderBy,
            } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: ,
                authDomain: "jswork-7558c.firebaseapp.com",
                projectId: "jswork-7558c",
                storageBucket: "jswork-7558c.appspot.com",
                messagingSenderId: "215719114362",
                appId: "1:215719114362:web:fe555875017463a7856dc3"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);

            // ğŸ”½ è¿½åŠ 
            const db = getFirestore(app);

            $("#send").on("click", function () {
                // é€ä¿¡æ™‚ã«å¿…è¦ãªå‡¦ç†
                const postData = {
                    name: $("#name").val(),
                    text: $("#text").val(),
                    time: serverTimestamp(),
                };
                //ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«chatã¨ã„ã†åå‰ã§ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ã„ã‚‹
                addDoc(collection(db, "chat"), postData);
                $("#text").val("");
            });

            // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯æ™‚é–“ã®æ–°ã—ã„é †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
            const q = query(collection(db, "chat"), orderBy("time", "asc"));

            // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†
            onSnapshot(q, (querySnapshot) => {
                console.log(querySnapshot.docs);
                //querySnapshot.docsã‚’å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡ºã—ãŸã€Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®é…åˆ—ã€ã«å¤‰æ›
                const documents = [];
                querySnapshot.docs.forEach(function (doc) {
                    const document = {
                        id: doc.id,
                        data: doc.data(),
                    };
                    documents.push(document);
                });

                console.log(documents);
                //å¿…è¦ãªæƒ…å ±ã®ã¿ã‚’æŠ½å‡ºã—ãŸé…åˆ—ãŒä½œæˆã§ããŸãŸã‚ã“ã®é…åˆ—ã‹ã‚‰ç”»é¢è¡¨ç¤ºç”¨ã®ã‚¿ã‚°ã‚’ä½œæˆ
                //æ™‚åˆ»å½¢å¼ã‚’å¤‰æ›
                const htmlElements = [];
                documents.forEach(function (document) {
                    htmlElements.push(`
                    <li id="${document.id}">
                    <p>${document.data.name} at ${convertTimestampToDatetime(document.data.time.seconds)}</p>
                    <p>${document.data.text}</p>
                    </li>
                    `);
                });

                $("#output").html(htmlElements);
            });

        </script>
    </main>
</body>

<footer>
    <nav class="wrapper-footer">
        <ul class="menu-footer">
            <li class="footer-first"><a href="#">åˆã‚ã¦ã®æ–¹ã¸</a></li>
            <li class="footer-question"><a href="#">ã‚ˆãã‚ã‚‹è³ªå•</a></li>
            <li class="footer-rule"><a href="#">åˆ©ç”¨è¦ç´„</a></li>
            <li class="footer-treat"><a href="#">ç‰¹å®šå•†å“å–å¼•æ³•</a></li>
            <li class="footer-policy"><a href="#">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></li>
            <li class="footer-contact"><a href="#">ãŠå•ã„åˆã‚ã›</a></li>
            <li class="footer-CoInfo"><a href="#">ä¼šç¤¾æ¦‚è¦</a></li>
        </ul>
    </nav>
    <h5 class="copy-rights">Â©ï¸2023 Cloud Garage Co,.Ltd. All Rights Reserved</h5>
</footer>

</html>